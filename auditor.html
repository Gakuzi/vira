<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ ‚Äî –ê—É–¥–∏—Ç–æ—Ä</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
  <!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π HTML ... -->

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–¥–µ–ª–∏ -->
  <div id="week-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–µ–ª—é</h2>
        <button class="close-modal" onclick="closeModal('week-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏</label>
          <input type="text" id="week-title" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–µ–¥–µ–ª—è 1: –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ">
        </div>
        <div class="form-row">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</label>
          <textarea id="week-description" class="form-control" rows="4" placeholder="–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç –Ω–∞ –Ω–µ–¥–µ–ª—é..."></textarea>
        </div>
        <div class="form-row">
          <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
          <input type="text" id="week-start" class="date-input" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
        </div>
        <div class="form-row">
          <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input type="text" id="week-end" class="date-input" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
        </div>
        <button class="btn btn-primary" onclick="saveWeek()">–°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–µ–ª—é</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–ª–∞–Ω–∞ –¥–Ω—è -->
  <div id="day-plan-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">–ü–ª–∞–Ω –Ω–∞ <span id="plan-date"></span></h2>
        <button class="close-modal" onclick="closeModal('day-plan-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="day-tasks-container"></div>
        <button class="btn btn-outline" onclick="addTaskField()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <button class="btn btn-primary" onclick="saveDayPlan()" style="margin-top: 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏—è -->
  <div id="event-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h2>
        <button class="close-modal" onclick="closeModal('event-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</label>
          <select id="event-type" class="form-control">
            <option value="task">‚úÖ –ó–∞–¥–∞—á–∞</option>
            <option value="interview">üé§ –ò–Ω—Ç–µ—Ä–≤—å—é</option>
            <option value="note">üìù –ó–∞–º–µ—Ç–∫–∞</option>
            <option value="scheme">üìä –°—Ö–µ–º–∞</option>
            <option value="audio">üéôÔ∏è –ê—É–¥–∏–æ</option>
            <option value="video">üé• –í–∏–¥–µ–æ</option>
          </select>
        </div>
        <div id="event-content-field">
          <div class="form-row">
            <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
            <textarea id="event-content" class="form-control" rows="4"></textarea>
          </div>
        </div>
        <div id="media-controls" class="hidden">
          <button class="btn btn-warning" id="start-recording">‚è∫Ô∏è –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
          <button class="btn btn-success hidden" id="stop-recording">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <div id="media-preview"></div>
        </div>
        <div id="scheme-editor" class="hidden">
          <div class="form-row">
            <label>–ö–æ–¥ —Å—Ö–µ–º—ã (Mermaid)</label>
            <textarea id="scheme-code" class="form-control" rows="6">graph LR
A[–°–∫–ª–∞–¥] --> B[–í—ã–¥–∞—á–∞]
B --> C[–û–±—ä–µ–∫—Ç]
C --> D[–í–æ–∑–≤—Ä–∞—Ç]</textarea>
          </div>
          <div id="scheme-preview" class="scheme-container"></div>
        </div>
        <button class="btn btn-primary" onclick="saveEvent()" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ... –∏–º–ø–æ—Ä—Ç—ã ...
    import { MediaRecorderHelper } from './js/media.js';

    let currentWeekId = null;
    let currentDayDate = null;
    let mediaHelper = null;
    let isRecording = false;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
    document.getElementById('event-type')?.addEventListener('change', function() {
      const type = this.value;
      const contentField = document.getElementById('event-content-field');
      const mediaControls = document.getElementById('media-controls');
      const schemeEditor = document.getElementById('scheme-editor');
      
      contentField.classList.toggle('hidden', ['audio', 'video'].includes(type));
      mediaControls.classList.toggle('hidden', !['audio', 'video'].includes(type));
      schemeEditor.classList.toggle('hidden', type !== 'scheme');
      
      if (type === 'scheme') {
        renderSchemePreview();
      }
    });

    // –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ
    document.getElementById('start-recording')?.addEventListener('click', async function() {
      const type = document.getElementById('event-type').value;
      mediaHelper = new MediaRecorderHelper();
      const success = await mediaHelper.startRecording(type);
      
      if (success) {
        isRecording = true;
        this.classList.add('hidden');
        document.getElementById('stop-recording').classList.remove('hidden');
      }
    });

    document.getElementById('stop-recording')?.addEventListener('click', function() {
      if (isRecording && mediaHelper) {
        const blob = mediaHelper.stopRecording();
        const player = mediaHelper.createPlayer(blob, document.getElementById('event-type').value);
        document.getElementById('media-preview').innerHTML = '';
        document.getElementById('media-preview').appendChild(player);
        
        isRecording = false;
        this.classList.add('hidden');
        document.getElementById('start-recording').classList.remove('hidden');
      }
    });

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ö–µ–º—ã
    function renderSchemePreview() {
      const code = document.getElementById('scheme-code').value;
      const preview = document.getElementById('scheme-preview');
      preview.innerHTML = `<pre class="mermaid">${code}</pre>`;
      mermaid.run({ querySelector: '.mermaid' });
    }

    document.getElementById('scheme-code')?.addEventListener('input', debounce(renderSchemePreview, 500));

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
    window.createWeek = function() {
      document.getElementById('week-modal').classList.remove('hidden');
    };

    window.saveWeek = async function() {
      const title = document.getElementById('week-title').value;
      const description = document.getElementById('week-description').value;
      const startStr = document.getElementById('week-start').value;
      const endStr = document.getElementById('week-end').value;
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –î–î.–ú–ú.–ì–ì–ì–ì –≤ –ì–ì–ì–ì-–ú–ú-–î–î
      const start = parseRussianDate(startStr);
      const end = parseRussianDate(endStr);
      
      if (!title || !start || !end) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      try {
        await createWeek({
          title,
          description,
          start_date: start,
          end_date: end,
          plan: {}
        });
        closeModal('week-modal');
        initApp();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    };

    // –ü–ª–∞–Ω –¥–Ω—è
    window.editDayPlan = function(weekId, dateStr) {
      currentWeekId = weekId;
      currentDayDate = dateStr;
      document.getElementById('plan-date').textContent = formatDate(dateStr);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏
      loadWeeks().then(weeks => {
        const week = weeks.find(w => w.id === weekId);
        const tasks = week?.plan?.[dateStr]?.tasks || [];
        renderTaskFields(tasks);
        document.getElementById('day-plan-modal').classList.remove('hidden');
      });
    };

    function renderTaskFields(tasks) {
      const container = document.getElementById('day-tasks-container');
      container.innerHTML = '';
      
      tasks.forEach((task, index) => {
        addTaskField(task);
      });
      
      if (tasks.length === 0) {
        addTaskField();
      }
    }

    window.addTaskField = function(task = '') {
      const container = document.getElementById('day-tasks-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'form-row';
      div.innerHTML = `
        <label>–ó–∞–¥–∞—á–∞ ${index + 1}</label>
        <input type="text" class="form-control task-input" value="${task}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
      `;
      container.appendChild(div);
    };

    window.saveDayPlan = async function() {
      const inputs = document.querySelectorAll('.task-input');
      const tasks = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(task => task);
      
      const weeks = await loadWeeks();
      const week = weeks.find(w => w.id === currentWeekId);
      if (!week) return;
      
      const updatedPlan = { ...(week.plan || {}) };
      updatedPlan[currentDayDate] = {
        tasks: tasks,
        approved: false // –ù–æ–≤—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
      };
      
      await updateWeek(currentWeekId, { plan: updatedPlan });
      closeModal('day-plan-modal');
      initApp();
    };

    // –°–æ–±—ã—Ç–∏—è
    window.openEventModal = function(weekId, dateStr) {
      currentWeekId = weekId;
      currentDayDate = dateStr;
      document.getElementById('event-modal').classList.remove('hidden');
    };

    window.saveEvent = async function() {
      const type = document.getElementById('event-type').value;
      let content = '';
      let fileUrls = [];
      
      if (['audio', 'video'].includes(type)) {
        // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å blob –≤ Supabase Storage
        // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø
        content = `–ó–∞–ø–∏—Å—å ${type}`;
      } else if (type === 'scheme') {
        content = document.getElementById('scheme-code').value;
      } else {
        content = document.getElementById('event-content').value;
      }
      
      if (!content.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ');
        return;
      }
      
      try {
        await createEvent({
          week_id: currentWeekId,
          day_date: currentDayDate,
          type,
          author: '–ö–ª–∏–º–æ–≤ –ï.–ê.',
          content,
          file_urls: fileUrls,
          is_approved: false
        });
        
        closeModal('event-modal');
        initApp();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    };

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function parseRussianDate(dateStr) {
      const parts = dateStr.split('.');
      if (parts.length === 3) {
        const day = parts[0].padStart(2, '0');
        const month = parts[1].padStart(2, '0');
        const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        return `${year}-${month}-${day}`;
      }
      return null;
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
  </script>
</body>
</html>
