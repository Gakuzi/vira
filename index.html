<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ ‚Äî –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ ‚Äî –û–∫—Ç—è–±—Ä—å 2025</h1>
      <div class="subtitle">–ü–∞–Ω–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</div>
    </div>

    <div class="user-info">
      <p>–†–µ–∂–∏–º: <strong>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</strong></p>
      <p>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å—é —Ä–∞–±–æ—Ç—É –∞—É–¥–∏—Ç–æ—Ä–∞, –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏</p>
      <div style="margin-top:10px; font-size:14px; color:#64748b;">
        <a href="auditor.html" style="color:#3b82f6; text-decoration:underline;">–í—Ö–æ–¥ –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∞</a>
      </div>
    </div>

    <div class="card">
      <div id="weeks-container">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
    </div>

    <div class="notification" id="notification"></div>
  </div>

  <div class="footer">
    CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ | –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
  </div>

  <script type="module">
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './js/config.js';
    import { loadWeeks, loadEvents, createEvent } from './js/db.js';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showNotification(message) {
      const notif = document.getElementById('notification');
      if (notif) {
        notif.textContent = message;
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 5000);
      }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–µ–¥–µ–ª—å (–±–µ–∑ –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    async function renderWeeks(weeks) {
      const container = document.getElementById('weeks-container');
      if (!container) return;
      
      container.innerHTML = weeks.map(week => `
        <div class="card">
          <div class="week-header">
            <div class="week-title" onclick="toggleWeek(${week.id})">
              üìÖ ${week.title} (${week.start_date} ‚Äì ${week.end_date})
            </div>
            <div class="week-meta">
              <span class="status-badge status-${week.status}">${getStatusText(week.status)}</span>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${week.progress}%"></div>
          </div>
          <div class="days-grid" id="days-${week.id}" style="display:none;"></div>
        </div>
      `).join('');
    }

    function getStatusText(status) {
      const texts = {
        draft: '–ß–µ—Ä–Ω–æ–≤–∏–∫',
        approved: '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ',
        in_progress: '–í —Ä–∞–±–æ—Ç–µ',
        completed: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
      };
      return texts[status] || status;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–Ω–µ–π (–±–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞–Ω–∞)
    async function renderDays(weekId, week, events) {
      const container = document.getElementById(`days-${weekId}`);
      if (!container) return;
      
      const daysMap = {};
      events.forEach(e => {
        if (!daysMap[e.day_date]) daysMap[e.day_date] = [];
        daysMap[e.day_date].push(e);
      });
      
      const start = new Date(week.start_date);
      const end = new Date(week.end_date);
      let current = new Date(start);
      const daysHTML = [];
      
      while (current <= end) {
        const day = current.getDay();
        if (day !== 0 && day !== 6) {
          const dateStr = current.toISOString().split('T')[0];
          const plan = week.plan?.[dateStr] || [];
          
          daysHTML.push(`
            <div class="day-card">
              <div class="day-header">
                <div class="day-date">${formatDate(dateStr)} (${getDayName(dateStr)})</div>
              </div>
              
              ${plan.length ? `
                <div style="margin-bottom: 16px;">
                  <strong>–ü–ª–∞–Ω:</strong>
                  <ul style="margin-top: 8px; padding-left: 20px;">
                    ${plan.map(task => `<li>${task}</li>`).join('')}
                  </ul>
                </div>
              ` : '<p style="color:#64748b; font-style:italic;">–ü–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω</p>'}
              
              <div id="events-${weekId}-${dateStr}">
                ${(daysMap[dateStr] || []).map(e => `
                  <div class="event">
                    <div class="event-header">
                      <span class="event-author">${e.author}</span>
                      <span class="event-time">${new Date(e.created_at).toLocaleTimeString()}</span>
                    </div>
                    <div class="event-content">
                      <strong>${getEventTypeText(e.type)}:</strong> ${e.content}
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div class="day-actions">
                <button class="btn btn-warning" onclick="addMeeting(${weekId}, '${dateStr}')">üìÖ –í—Å—Ç—Ä–µ—á–∞</button>
              </div>
              
              <div class="comment-form">
                <div class="form-group">
                  <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –í–æ–ø—Ä–æ—Å:</label>
                  <textarea class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." 
                    onkeypress="handleComment(event, ${weekId}, '${dateStr}')"></textarea>
                </div>
              </div>
            </div>
          `);
        }
        current.setDate(current.getDate() + 1);
      }
      
      container.innerHTML = daysHTML.join('');
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function getDayName(dateStr) {
      const names = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      return names[new Date(dateStr).getDay()];
    }

    function getEventTypeText(type) {
      const types = {
        task: '–ó–∞–¥–∞—á–∞',
        interview: '–ò–Ω—Ç–µ—Ä–≤—å—é',
        note: '–ó–∞–º–µ—Ç–∫–∞',
        meeting: '–í—Å—Ç—Ä–µ—á–∞',
        comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
        scheme: '–°—Ö–µ–º–∞'
      };
      return types[type] || type;
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.toggleWeek = async (weekId) => {
      const el = document.getElementById(`days-${weekId}`);
      const title = document.querySelector(`.week-title[onclick="toggleWeek(${weekId})"]`);
      
      if (el.style.display === 'grid') {
        el.style.display = 'none';
        title.classList.add('collapsed');
      } else {
        el.style.display = 'grid';
        title.classList.remove('collapsed');
        
        if (!el.innerHTML.trim()) {
          const weeks = await loadWeeks();
          const week = weeks.find(w => w.id === weekId);
          if (week) {
            const events = await loadEvents(weekId);
            renderDays(weekId, week, events);
          }
        }
      }
    };

    window.addMeeting = (weekId, dateStr) => {
      const content = prompt('–ü–æ–≤–µ—Å—Ç–∫–∞ –≤—Å—Ç—Ä–µ—á–∏:');
      if (content) addEvent(weekId, dateStr, 'meeting', content);
    };

    window.handleComment = async (e, weekId, dateStr) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const textarea = e.target;
        const content = textarea.value.trim();
        if (content) {
          await addEvent(weekId, dateStr, 'comment', content);
          textarea.value = '';
        }
      }
    };

    async function addEvent(weekId, dateStr, type, content) {
      try {
        await createEvent({ week_id: weekId, day_date: dateStr, type, author: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', content });
        
        const events = await loadEvents(weekId);
        const weeks = await loadWeeks();
        const week = weeks.find(w => w.id === weekId);
        if (week) {
          renderDays(weekId, week, events);
        }
        
        showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
      try {
        const weeks = await loadWeeks();
        renderWeeks(weeks);
      } catch (error) {
        document.getElementById('weeks-container').innerHTML = 
          `<div class="card" style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
