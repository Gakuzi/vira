<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ ‚Äî –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ ‚Äî –û–∫—Ç—è–±—Ä—å 2025</h1>
      <div class="subtitle">–ü–∞–Ω–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</div>
    </div>

    <div class="user-info">
      <p>–†–µ–∂–∏–º: <strong>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</strong></p>
      <p>–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å—é —Ä–∞–±–æ—Ç—É –∞—É–¥–∏—Ç–æ—Ä–∞, –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏</p>
      <div style="margin-top:10px; font-size:14px; color:#64748b;">
        <a href="auditor.html" style="color:#3b82f6; text-decoration:underline;">–í—Ö–æ–¥ –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∞</a>
      </div>
    </div>

    <div class="card">
      <div id="weeks-container">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
    </div>

    <div class="notification" id="notification"></div>
  </div>

  <div class="footer">
    CRM –¥–ª—è –∞—É–¥–∏—Ç–∞ —Å–∫–ª–∞–¥–∞ | –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
  </div>

  <script type="module">
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å auditor.html) ===
    const SUPABASE_URL = 'https://effpidrlccjmnxmbtkiz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZnBpZHJsY2NqbW54bWJ0a2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDQ5NDUsImV4cCI6MjA3NDcyMDk0NX0.SwJumspCD2x1Fsul4yw2LBL-OSj-4giXeBl99D1fFLg';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === –§–£–ù–ö–¶–ò–ò ===
    function showNotification(message) {
      const notif = document.getElementById('notification');
      if (notif) {
        notif.textContent = message;
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 5000);
      }
    }

    // === –†–ï–ù–î–ï–†–ò–ù–ì ===
    async function renderWeeks(weeks) {
      const container = document.getElementById('weeks-container');
      if (!container) return;
      
      container.innerHTML = weeks.map(week => `
        <div class="card">
          <div class="week-header">
            <div class="week-title" onclick="toggleWeek(${week.id})">
              üìÖ ${week.title} (${formatDate(week.start_date)} ‚Äì ${formatDate(week.end_date)})
            </div>
            <div class="week-meta">
              <span class="status-badge status-${week.status}">${getStatusText(week.status)}</span>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${week.progress}%"></div>
          </div>
          
          <div class="recent-events">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
            <div id="recent-${week.id}">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
          
          <div class="days-grid" id="days-${week.id}" style="display:none;"></div>
        </div>
      `).join('');
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π
      weeks.forEach(async (week) => {
        const events = await loadEvents(week.id);
        const recentEvents = events.slice(-10).reverse();
        const recentContainer = document.getElementById(`recent-${week.id}`);
        if (recentContainer) {
          recentContainer.innerHTML = recentEvents.length ? 
            recentEvents.map(e => `
              <div class="mini-event">
                <div class="mini-event-icon">${getEventIcon(e.type)}</div>
                <div class="mini-event-content">
                  <strong>${e.author}</strong>: ${e.content?.substring(0, 80)}${e.content?.length > 80 ? '...' : ''}
                  <div style="font-size:12px; color:#64748b; margin-top:4px;">
                    ${formatDateTime(e.created_at)}
                  </div>
                </div>
              </div>
            `).join('') : '<p style="color:#64748b;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
        }
      });
    }

    function getStatusText(status) {
      const texts = {
        draft: '–ß–µ—Ä–Ω–æ–≤–∏–∫',
        pending_approval: '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏',
        approved: '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ',
        in_progress: '–í —Ä–∞–±–æ—Ç–µ',
        completed: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
      };
      return texts[status] || status;
    }

    async function renderDays(weekId, week, events) {
      const container = document.getElementById(`days-${weekId}`);
      if (!container) return;
      
      const daysMap = {};
      events.forEach(e => {
        if (!daysMap[e.day_date]) daysMap[e.day_date] = [];
        daysMap[e.day_date].push(e);
      });
      
      const start = new Date(week.start_date);
      const end = new Date(week.end_date);
      let current = new Date(start);
      const daysHTML = [];
      
      while (current <= end) {
        const day = current.getDay();
        if (day !== 0 && day !== 6) {
          const dateStr = current.toISOString().split('T')[0];
          const dayPlan = week.plan?.[dateStr] || { tasks: [], approved: false };
          
          daysHTML.push(`
            <div class="day-card">
              <div class="day-header">
                <div class="day-date">${formatDate(dateStr)} (${getDayName(dateStr)})</div>
              </div>
              
              ${dayPlan.tasks.length ? `
                <div style="margin-bottom: 16px;">
                  <strong>–ü–ª–∞–Ω ${dayPlan.approved ? '‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω' : '‚è≥ –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏'}:</strong>
                  <ul style="margin-top: 8px; padding-left: 20px;">
                    ${dayPlan.tasks.map(task => `<li>${task}</li>`).join('')}
                  </ul>
                </div>
              ` : '<p style="color:#64748b; font-style:italic;">–ü–ª–∞–Ω –Ω–µ –∑–∞–¥–∞–Ω</p>'}
              
              <div id="events-${weekId}-${dateStr}">
                ${(daysMap[dateStr] || []).map(e => `
                  <div class="event">
                    <div class="event-header">
                      <span class="event-author">${e.author}</span>
                      <span class="event-time">${formatDateTime(e.created_at)}</span>
                    </div>
                    <div class="event-content">
                      <strong>${getEventTypeText(e.type)}:</strong> ${e.content}
                      ${e.is_approved ? '<span class="event-badge approved">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>' : '<span class="event-badge not-approved">–ù–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>'}
                      
                      ${e.file_metadata ? `
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px;">
                          <strong>üìé –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:</strong><br>
                          <a href="${e.file_metadata.url}" target="_blank" style="color: #2563eb; text-decoration: underline;">
                            ${e.file_metadata.name}
                          </a>
                          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                            ${formatFileSize(e.file_metadata.size)} ‚Ä¢ ${e.file_metadata.type}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div class="day-actions">
                <button class="btn btn-warning" onclick="addMeeting(${weekId}, '${dateStr}')">üìÖ –í—Å—Ç—Ä–µ—á–∞</button>
              </div>
              
              <div class="comment-form">
                <div class="form-group">
                  <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –í–æ–ø—Ä–æ—Å:</label>
                  <textarea class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." 
                    onkeypress="handleComment(event, ${weekId}, '${dateStr}')"></textarea>
                </div>
              </div>
            </div>
          `);
        }
        current.setDate(current.getDate() + 1);
      }
      
      container.innerHTML = daysHTML.join('');
    }

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
    }

    function formatDateTime(dateTimeStr) {
      const d = new Date(dateTimeStr);
      return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    function getDayName(dateStr) {
      const names = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      return names[new Date(dateStr).getDay()];
    }

    function getEventTypeText(type) {
      const types = {
        task: '–ó–∞–¥–∞—á–∞',
        interview: '–ò–Ω—Ç–µ—Ä–≤—å—é',
        note: '–ó–∞–º–µ—Ç–∫–∞',
        meeting: '–í—Å—Ç—Ä–µ—á–∞',
        comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
        scheme: '–°—Ö–µ–º–∞',
        document: '–î–æ–∫—É–º–µ–Ω—Ç'
      };
      return types[type] || type;
    }

    function getEventIcon(type) {
      const icons = {
        task: '‚úÖ',
        interview: 'üé§',
        note: 'üìù',
        meeting: 'üìÖ',
        comment: 'üí¨',
        scheme: 'üìä',
        document: 'üìé'
      };
      return icons[type] || 'üìÑ';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 –ë';
      const k = 1024;
      const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // === API –§–£–ù–ö–¶–ò–ò ===
    async function loadWeeks() {
      const { data, error } = await supabase
        .from('weeks')
        .select('*')
        .order('start_date', { ascending: true });
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–µ–ª—å:', error);
        document.getElementById('weeks-container').innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
        return [];
      }
      return data;
    }

    async function loadEvents(weekId) {
      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('week_id', weekId)
        .order('created_at', { ascending: true });
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
        return [];
      }
      return data;
    }

    async function createEvent(eventData) {
      const { data, error } = await supabase
        .from('events')
        .insert([eventData])
        .select();
      if (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
        throw error;
      }
      return data[0];
    }

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    window.toggleWeek = async (weekId) => {
      const el = document.getElementById(`days-${weekId}`);
      const title = document.querySelector(`.week-title[onclick="toggleWeek(${weekId})"]`);
      
      if (el.style.display === 'grid') {
        el.style.display = 'none';
        title.classList.add('collapsed');
      } else {
        el.style.display = 'grid';
        title.classList.remove('collapsed');
        
        if (!el.innerHTML.trim()) {
          const weeks = await loadWeeks();
          const week = weeks.find(w => w.id === weekId);
          if (week) {
            const events = await loadEvents(weekId);
            renderDays(weekId, week, events);
          }
        }
      }
    };

    window.handleComment = async (e, weekId, dateStr) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const textarea = e.target;
        const content = textarea.value.trim();
        if (content) {
          await createEvent({
            week_id: weekId,
            day_date: dateStr,
            type: 'comment',
            author: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
            content
          });
          textarea.value = '';
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          init();
        }
      }
    };

    window.addMeeting = (weekId, dateStr) => {
      const content = prompt('–ü–æ–≤–µ—Å—Ç–∫–∞ –≤—Å—Ç—Ä–µ—á–∏:');
      if (content) {
        createEvent({
          week_id: weekId,
          day_date: dateStr,
          type: 'meeting',
          author: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
          content
        }).then(() => init());
      }
    };

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    async function init() {
      try {
        const weeks = await loadWeeks();
        renderWeeks(weeks);
      } catch (error) {
        document.getElementById('weeks-container').innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
