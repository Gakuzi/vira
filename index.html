<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM для аудита склада — Руководитель</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CRM для аудита склада — Октябрь 2025</h1>
      <div class="subtitle">Панель руководителя</div>
    </div>

    <div class="user-info">
      <p>Режим: <strong>Руководитель</strong></p>
      <p>Вы можете просматривать всю работу аудитора, комментировать и планировать встречи</p>
      <div style="margin-top:10px; font-size:14px; color:#64748b;">
        <a href="auditor.html" style="color:#3b82f6; text-decoration:underline;">Вход для аудитора</a>
      </div>
    </div>

    <div class="card">
      <div id="weeks-container">
        <p>Загрузка данных...</p>
      </div>
    </div>

    <div class="notification" id="notification"></div>
  </div>

  <div class="footer">
    CRM для аудита склада | Руководитель
  </div>

  <script type="module">
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './js/config.js';
    import { loadWeeks, loadEvents, createEvent } from './js/db.js';
    import { showNotification, renderWeeksForManager, renderDaysForManager } from './js/ui.js';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Глобальные функции
    window.toggleWeek = async (weekId) => {
      const el = document.getElementById(`days-${weekId}`);
      const title = document.querySelector(`.week-title[onclick="toggleWeek(${weekId})"]`);
      
      if (el.style.display === 'grid') {
        el.style.display = 'none';
        title.classList.add('collapsed');
      } else {
        el.style.display = 'grid';
        title.classList.remove('collapsed');
        
        if (!el.innerHTML.trim()) {
          const weeks = await loadWeeks();
          const week = weeks.find(w => w.id === weekId);
          if (week) {
            const events = await loadEvents(weekId);
            renderDaysForManager(weekId, week, events);
          }
        }
      }
    };

    window.addMeeting = (weekId, dateStr) => {
      const content = prompt('Повестка встречи:');
      if (content) addEvent(weekId, dateStr, 'meeting', content);
    };

    window.handleComment = async (e, weekId, dateStr) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const textarea = e.target;
        const content = textarea.value.trim();
        if (content) {
          await addEvent(weekId, dateStr, 'comment', content);
          textarea.value = '';
        }
      }
    };

    async function addEvent(weekId, dateStr, type, content) {
      try {
        await createEvent({ week_id: weekId, day_date: dateStr, type, author: 'Руководитель', content });
        
        const events = await loadEvents(weekId);
        const weeks = await loadWeeks();
        const week = weeks.find(w => w.id === weekId);
        if (week) {
          renderDaysForManager(weekId, week, events);
        }
        
        showNotification('Сообщение отправлено!');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Инициализация
    async function init() {
      try {
        const weeks = await loadWeeks();
        renderWeeksForManager(weeks);
      } catch (error) {
        document.getElementById('weeks-container').innerHTML = 
          `<div class="card" style="color:red;">Ошибка загрузки данных: ${error.message}</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
